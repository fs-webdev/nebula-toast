<!--
@license
Copyright (c) 2017 Ars Nebula LLC.
This code may be used under the terms found in LICENSE.md of this repository.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-a11y-announcer/iron-a11y-announcer.html">
<link rel="import" href="../nebula-style-attributes-behavior/nebula-style-attributes-behavior.html">

<!--
`<nebula-toast>` is a custom element to display a toast notification. The notification can be auto-closed after a specified `duration`, or when the user taps or clicks the notification area. The notification can be displayed at the top or the bottom of the screen area.

> Warning: This element utilizes features of [ECMAScript 2015](http://www.ecma-international.org/ecma-262/6.0/) which may not be supported by all browsers. To ensure support by all browsers, consider using the [Core-js Polyfill](https://github.com/zloirock/core-js).

## Usage

```html
<nebula-toast
  id="toast"
  position='top'
  background-color="darkred"
  color="white"
  duration=5000>
</nebula-toast>
```

Add and configure the element programatically using the `show` method. The element is appended and removed from the `document.body` automatically. The method returns a promise that is resolved once the element closing animation is complete.

```js
var toast = Polymer.Base.create('nebula-toast', {
  text: 'Hello world',
  transition-duration: '0.5s',
  duration: 5000
})

toast.show().then(function() {
  console.log('The toast has closed')
})
```

## Style

You can style the element using CSS custom properties and mixins:

Custom property | Description | Default
:--- | :--- | :---
`--nebula-toast-color` | The text color. | white
`--nebula-toast-background-color` | The background color. | dimgrey
`--nebula-toast-transition-duration` | The animation speed showing and hiding the overlay. | 0.4s
`--nebula-toast-z-index` | The stacking order of the overlay. | 9999
`--nebula-toast` | Mixin applied to the base element.

The following styles can also be set as attributes on the element:

- `color`
- 'background-color'

@demo demo/index.html
-->

<dom-module id="nebula-toast">
  <template>
    <style>
      :host {
        --nebula-toast-background-color: dimgrey;
        --nebula-toast-color: white;
        --nebula-toast-transition-duration: 0.4s;
        --nebula-toast-z-index: 9999;
        position: fixed;
        left: 0;
        right: 0;
        width: 85%;
        max-width: 600px;
        margin: 16px auto;
        padding: 16px;
        border: 0;
        font-family: sans-serif;
        font-size: 1rem;
        border-radius: 2px;
        overflow: hidden;
        cursor: pointer;
        user-select: none;
        background-color: var(--nebula-toast-background-color);
        color: var(--nebula-toast-color);
        z-index: var(--nebula-toast-z-index);
        visibility: hidden;
        opacity: 0;
        transition: transform var(--nebula-toast-transition-duration) ease, opacity var(--nebula-toast-transition-duration) linear, visibility 0s linear var(--nebula-toast-transition-duration);
        @apply(--nebula-toast);
      }
      :host([position=top]) {
        top: 0;
        transform: translateY(-100%); 
      }
      :host([position=bottom]) {
        bottom: 0;
        transform: translateY(+100%);
      }
      :host([opened]) {
        transform: translateY(0%);
        opacity: 1;
        visibility: visible;
        transition: transform var(--nebula-toast-transition-duration) ease, opacity var(--nebula-toast-transition-duration) linear;
      }
    </style>
    [[text]]
  </template>
  <script>
    Polymer({
      /**
       * Event handler triggered when opening and closing animation is complete.
       */
      /**
       * Event triggered when element opening animation is complete.
       * @event opened
       */
      /**
       * Event triggered when element closing animation is complete.
       * @event closed
       */      
      is: 'nebula-toast',
      behaviors: [
        Nebula.StyleAttributesBehavior
      ],
      styleAttributes: {
        'color': '--nebula-toast-color',
        'background-color': '--nebula-toast-background-color'
      },
      properties: {
        /**
        * True if the toast is open, otherwise false.
        */
        opened: {
          type: Boolean,
          reflectToAttribute: true,
          notify: true,
          value: false
        },
        /**
        * Position of the toast.
        * Supported values are <b>top</b> or <b>bottom</b>.
        */
        position: {
          type: String,
          reflectToAttribute: true,
          value: 'bottom'
        },
        /**
        * The text that is displayed.
        * The element will resize to fit the content automatically.
        */
        text: {
          type: String
        },
        /**
        * The duration (ms) before the element is automatically closed.
        * Set the duration to zero to close the toast manually.
        */
        duration: {
          type: Number,
          value: 5000
        }
      },
      observers: [
        '_onOpenedChanged(opened, duration)'
      ],
      listeners: {
        'tap': '_onTap',
        'transitionend': '_onTransitionEnd'
      },
      /**
      * Lifecycle handler when element is ready.
      */
      ready: function() {
        Polymer.IronA11yAnnouncer.requestAvailability();
      },
      /**
      * Lifecycle handler triggered when a key is pressed down.
      * The handler is added and removed automatically when a toast is opened and closed.
      */ 
      _onKey: function(e) {
        var key = e.keyCode || e.which
        if (key === 27) {
          this.set('opened', false)
          return false
        }
      },
      /**
       * Event handler triggered when the user taps the element.
       * The element is automatically closed.
       */
      _onTap: function(e) {
        this.set('opened', false)
        return false
      },
      /**
       * Property observer triggered when the value of `opened` is changed.
       */
      _onOpenedChanged: function(opened, duration) {
        if (this.timeout) {
          clearTimeout(this.timeout)
          this.timeout = null
        }
        if (opened && duration > 0) {
          this.timeout = setTimeout(function() {
            this.set('opened', false)
          }.bind(this), duration)
        }
        if (opened) {
          document.addEventListener('keydown', this._onKey.bind(this))
        } else {
          document.removeEventListener('keydown', this._onKey)
        }
      },
      /**
       * Event handler triggered when the element opening or closing animation is complete.
       */
      _onTransitionEnd: function(e) {
        if (e.propertyName === 'opacity') {
          if (this.opened) {
            this.fire('opened', null, {bubbles: false})
            this.fire('iron-announce', {text: this.text}, { bubbles: true });
          }
          else {
            this.fire('closed', null, {bubbles: false})
          }
        }
      },
      /**
       * Displays the element.
       * Any provided options will be merged into the element properties.
       * A promise is returned that will resolve when the element has been closed.
       */
      show: function(options) {
        return new Promise(function(resolve) {
          // add element to document body if not parent
          if (!this.parentNode) {
            this._appended = true
            document.body.appendChild(this)
          }
          
          // listen for our own closed event and resolve promise
          var handler = function() {
            this.removeEventListener('closed', handler)

            if (this._appended) {
              this._appended = false
              document.body.removeChild(this)
            }

            resolve() 
          }
          this.addEventListener('closed', handler.bind(this))

          // open the toast in timeout closure to accomodate for animation
          // when appending new element
          setTimeout(function() {
            this.set('opened', true)
          }.bind(this))
        }.bind(this))
      }
    })
  </script>
</dom-module>
