<!--
@license
Copyright (c) 2017 Ars Nebula LLC.
This code may be used under the terms found in LICENSE.md of this repository.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">

<!--
`<nebula-toast>` is a custom element to display a toast notification. The notification can be auto-closed after a specified `duration`, or when the user taps or clicks the notification area. The notification can be displayed at the top or the bottom of the screen area.

```html
<nebula-toast
  id="toast"
  position='top'
  background-color="darkred"
  color="white"
  duration=5000>
</nebula-toast>
```

You can specify style values using the `color` and `backgroundColor` properties, or use the following CSS custom properties and mixins:

Custom property | Description
----------------|-------------
`--nebula-toast-color` | The text foreground color
`--nebula-toast-background-color` | The background color
`--nebula-toast-transition-duration` | The animation speed showing and hiding the overlay
`--nebula-toast-z-index` | The stacking order of the overlay
`--nebula-toast` | Mixin applied to the base element

You can use the `show` method to display a toast and wait for it to close. The method returns a promise that is resolved once the element closing animation is complete.

```js
this.$.toast.show({
  text: 'Hello world'
}).then(function() {
  console.log('The toast has closed')
})
```

@demo demo/index.html
-->

<dom-module id="nebula-toast">
  <template>
    <style>
      :host {
        --nebula-toast-background-color: dimgrey;
        --nebula-toast-color: white;
        --nebula-toast-transition-duration: 0.4s;
        --nebula-toast-z-index: 9999;
        position: fixed;
        left: 0;
        right: 0;
        width: 85%;
        max-width: 600px;
        margin: 16px auto;
        padding: 16px;
        border: 0;
        font-family: sans-serif;
        font-size: 1rem;
        border-radius: 2px;
        overflow: hidden;
        cursor: pointer;
        user-select: none;
        background-color: var(--nebula-toast-background-color);
        color: var(--nebula-toast-color);
        z-index: var(--nebula-toast-z-index);
        visibility: hidden;
        opacity: 0;
        transition: transform var(--nebula-toast-transition-duration) ease, opacity var(--nebula-toast-transition-duration) linear, visibility 0s linear var(--nebula-toast-transition-duration);
        @apply(--nebula-toast);
      }
      :host([position=top]) {
        top: 0;
        transform: translateY(-100%); 
      }
      :host([position=bottom]) {
        bottom: 0;
        transform: translateY(+100%);
      }
      :host([opened]) {
        transform: translateY(0%);
        opacity: 1;
        visibility: visible;
        transition: transform var(--nebula-toast-transition-duration) ease, opacity var(--nebula-toast-transition-duration) linear;
      }
    </style>
    [[text]]
  </template>
  <script>
    Polymer({
      is: 'nebula-toast',
      behaviors: [
        Polymer.IronA11yKeysBehavior
      ],
      properties: {
        /**
         * True if the toast is open, otherwise false.
         */
        opened: {
          type: Boolean,
          reflectToAttribute: true,
          notify: true,
          value: false
        },
        /**
         * Position of the toast.
         * Supported values are <b>top</b> or <b>bottom</b>.
         */
        position: {
          type: String,
          reflectToAttribute: true,
          value: 'bottom'
        },
        /**
         * The text that is displayed.
         * The element will resize to fit the content automatically.
         */
        text: {
          type: String
        },
        /**
         * The color of the element.
         * Setting this property will override the <b>--nebula-toast--color</b> custom CSS property.
         */
        color: {
          type: String
        },
        /**
         * The background color of the element.
         * Setting this property will override the <b>--nebula-toast-background-color</b> custom CSS property.
         */
        backgroundColor: {
          type: String
        },
        /**
         * The transition duration of the element.
         * Setting this property will override the <b>--nebula-toast-transition-duration</b> custom CSS property.
         */
        transitionDuration: {
          type: String
        },
        /**
         * The duration (ms) before the element is automatically closed.
         * Set the duration to zero to close the toast manually.
         */
        duration: {
          type: Number,
          value: 5000
        },
        /**
         * The target element used to capture keyboard events.
         * Set it to <b>null</b> to disable event listeners.
         */
        keyEventTarget: {
          type: Object,
          value: function() {
            return document.body
          }
        }
      },
      keyBindings: {
        'esc': '_onCancel'
      },
      observers: [
        '_onOpenedChanged(opened, duration)',
        '_onStyleChanged(color, "--nebula-toast-color")',
        '_onStyleChanged(backgroundColor, "--nebula-toast-background-color")',
        '_onStyleChanged(transitionDuration, "--nebula-toast-transition-duration")'
      ],
      listeners: {
        'tap': '_onCancel',
        'transitionend': '_onTransitionEnd',
      },
      ready() {
        Polymer.IronA11yAnnouncer.requestAvailability();
      },
      /**
       * Property observer triggered when the value of <b>opened</b> is changed.
       */
      _onOpenedChanged(opened, duration) {
        if (this.timeout) {
          clearTimeout(this.timeout)
          this.timeout = null
        }
        if (opened && duration > 0) {
          this.timeout = setTimeout(function() {
            this.set('opened', false)
          }.bind(this), duration)
        }        
      },
      /**
       * Property observer triggered when the value of any style-related property is changed.
       */
      _onStyleChanged(propName, varName) {
        this.updateStyles({
          [varName]: propName
        })
      },
      /**
       * Event handler triggered when opening and closing animation is complete.
       */
      /**
       * Event triggered when element opening animation is complete.
       * @event opened
       */
      /**
       * Event triggered when element closing animation is complete.
       * @event closed
       */      
      _onTransitionEnd(e) {
        if (e.propertyName === 'opacity') {
          if (this.opened) {
            this.fire('opened', null, {bubbles: false})
            this.fire('iron-announce', {text: this.textContent}, { bubbles: true });
          }
          else {
            this.fire('closed', null, {bubbles: false})
          }
        }
      },
      /**
       * Event handler triggered when the user cancels the element by tap, click or ESC keypress.
       */
      _onCancel(e) {
        if (this.opened) {
          e.stopPropagation()
          this.set('opened', false)
        }
      },
      /**
       * Displays the element.
       * Any provided options will be merged into the element properties.
       * A promise is returned that will resolve when the element has been closed.
       */
      show(options) {
        return new Promise(function(resolve) {
          if (options) Object.assign(this, options)

          // add element to document body if not parent
          if (!this.parentNode) {
            this._appended = true
            document.body.appendChild(this)
          }
          
          // listen for our own closed event and resolve promise
          var handler = function() {
            this.removeEventListener('closed', handler)

            if (this._appended) {
              this._appended = false
              document.body.removeChild(this)
            }

            resolve() 
          }
          this.addEventListener('closed', handler.bind(this))

          // open the toast in timeout closure to accomodate for animation
          // when appending new element
          setTimeout(function() {
            this.set('opened', true)
          }.bind(this))
        }.bind(this))
      }
    })
  </script>
</dom-module>
